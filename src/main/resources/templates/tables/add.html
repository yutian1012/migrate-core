<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>添加迁移表规则</title>
	<script src="/webjars/jquery/3.2.0/dist/jquery.min.js"></script>
	<script type="text/javascript">
		var sourceTableModel=null;
		var targetTableModel=null;
		
		function changeTable(source){
			var tableName='';
			if(source){
				tableName=$("#sourceTableSelect").val();
			}else{
				tableName=$("#targetTableSelect").val();
			}
			
			if(tableName==''){
				if(source){
					sourceTableModel=null;
				}else{
					targetTableModel=null;
				}
				return false;
			}
			$.post("/tables/getTable",{ "isSourceTable" : source , "tableName" : tableName }, function(data){
		          if(data){
		        	  if(source){
		        		  sourceTableModel=data;
		        	  }else{
		        		  targetTableModel=data;
		        	  }
		          }
		    });
		}
		
		function displayTable(){
			if(sourceTableModel){
      		  	//清空源表显示信息
      		  	$("#sourceTable").empty();//清空内容
				for(var index=0;index<sourceTableModel.columnList.length;index++){
	      		  	var column=sourceTableModel.columnList[index];
	      			$("#sourceTable").append("<tr><td>"+column["name"]+"</td></tr>");
	      	  	}
			}
		}
		
		function addTable(){
			window.location.href='/tables/add';
		}
		
		//添加转换字段
		function addField(){
			if(targetTableModel==null||sourceTableModel==null){
				alert("请先选择待迁移的数据表!!!");
				return false;
			}
			
			var table=$("#migrateTable");
			
			var index=$("#migrateTable tr").length-1;
			
			var html=$("<tr></tr>");//创建行数据
			//目标表字段
			html.append($("<td></td>").append(getTableFieldColumn(targetTableModel,"filedList["+index+"].name")));
			//值来源
			html.append("<td><select name='"+"filedList["+index+"].valueType"+"'><option value='FIXED'>固定值</option><option>字段值</option></select></td>");
			//数据值
			html.append($("<td></td>").append(getTableFieldValue(true,"filedList["+index+"].value")));
			//默认值
			html.append($("<td></td>").append(getTableFieldDefaultValue()));
			//格式化
			html.append("<td></td>");
			
			$("#migrateTable").append(html);
		}
		//获取表字段选项
		function getTableFieldColumn(table,name){
			var select=$("<select name='"+name+"'></select>");//设置name字段值
			if(table!=null){
				for(var index=0;index<table.columnList.length;index++){
	      		  	var column=table.columnList[index];
	      			select.append("<option>"+column["name"]+"</option>");
	      	  	}
			}
			return select;
		}
		//获取表字段数据值
		function getTableFieldValue(fixed,name){
			if(fixed){//固定值，由用户输入
				return $("<input type='text' name='"+name+"'>");
			}else{//字段值，从源表中选择
				return getTableFieldColumn(sourceTableModel,name);
			}
		}
		//获取表字段默认值
		function getTableFieldDefaultValue(name){
			return $("<input type='text'>");
		}
		
		/* //目标字段改变
		function changeField(obj){
			var name=$(obj).attr("name");
			if(name.indexOf("target")!=-1){
				//清空所有默认值
			}
		} */
		
	</script>
</head>
<body>
	<form th:action="@{/tables/saveTable}" method="post">
		<div><label>迁移数据信息：</label><input type="text" name="note"></div>
		<div>
			<!-- 源表必须要提供相应的主键 -->
			<label>选择源表</label>
			<select name="from" id="sourceTableSelect"  onchange="changeTable(true);">
				<option>请选择</option>
				<option th:each="tableName:${sourceTableList}" th:text="${tableName}" th:value="${tableName}"></option>
			</select>
		</div>
		<div>
			<label>选择目标表</label>
			<select name="to" id="targetTableSelect"  onchange="changeTable(false);">
				<option>请选择</option>
				<option th:each="tableName:${targetTableList}" th:text="${tableName}" th:value="${tableName}"></option>
			</select>
		</div>
		
		<!-- 表信息展示区域 -->
		<div >
			<label>目标表表名：</label><span id="targetTableName"></span>
			<span style="width:20px;"></span>
			<label>备注</label>
			<label>源表表名：</label><span id="sourceTableName"></span>
			<span style="width:20px;"></span>
			<label>备注</label>
			
			<div>
				<label>字段信息：</label><input type="button" value="添加字段" onclick="addField();">
				<table id="migrateTable">
					<tr>
						<td>目标表字段</td>
						<td>值来源</td>
						<td>数据值</td>
						<td>默认值</td>
						<td>格式化</td>
					</tr>
				</table>
			</div>
			<div>
				<label>关联条件</label><input type="button" value="添加字段" onclick="addConditionField();">
				<table id="migrateCondition">
					<tr>
						<td>应用目标</td>
						<td>字段</td>
						<td>值来源</td>
						<td>数据值</td>
						<td>默认值</td>
					</tr>
				</table>
			</div>
		</div>
		
		<div><input type="submit" value="提交"></div>
	</form>
	
	<div>
		<!-- <span style="display: none;" id="migrateFieldTemplate">
			<tr>
				<td>目标表字段</td>
				<td>值来源</td>
				<td>数据值</td>
				<td>默认值</td>
				<td>格式化</td>
			</tr>
		</span> -->
	</div>
</body>
</html>